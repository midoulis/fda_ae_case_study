---
title: "openFDA medicinal product coocc"
output: html_notebook
---

This function calls the adverse events endpoint of the openFDA API to retrieve reports submitted between 01-01-2016 and 01-06-20117. There is a limit of 100 reports you can retrieve per query. 
```{r}

get_data <- function(k){
  
  api_url <- "https://api.fda.gov/drug/event.json?search=receivedate:[20160101+TO+20170601]&limit=100"
  data <- jsonlite::fromJSON(api_url, simplifyDataFrame = T)
  data <- data$results
  data <- data$patient
  data <- data$drug

  data <- sapply(data,function(x) x$medicinalproduct)
  all_data <- data
  
  for(i in 1:k){
    api_url <- paste("https://api.fda.gov/drug/event.json?search=receivedate:[20160101+TO+20170601]&limit=100&skip=", i*100, sep = "")
    data <- jsonlite::fromJSON(api_url, simplifyDataFrame = T)
    data <- data$results
    data <- data$patient
    data <- data$drug

    data <- sapply(data,function(x) x$medicinalproduct)
    all_data <- c(all_data,data)
  }
  return(all_data)
}

```


Get the 10000 reports and clean the data (drug names)
```{r}

all_reports <- get_data(99)
all_reports <- sapply(all_reports, function(x) gsub("\\.","",x))
all_reports <- sapply(all_reports, function(x) gsub("\\{","",x))



meds_list <- as(all_reports, "transactions")

summary((meds_list))
summary(itemFrequency(meds_list))

frequentMeds <- apriori(meds_list, parameter=list(target="frequent", supp = 0.01))
itemFrequencyPlot(meds_list, topN = 5, type="absolute")

rules <- apriori(meds_list,parameter = list(supp=0.002, conf = 0.01, maxlen = 10, minlen = 2))
#, appearance = list (default="rhs",lhs="RETROVIR")
rules <- rules[!is.redundant(rules, measure = "lift")]
inspect(rules[!is.redundant(rules, measure = "lift")])

sorted_rules <- sort(rules, by = "lift", decreasing = T)

inspect(head(sorted_rules, n=50))

```


```{r}
#convert the list to class transactions to use with the arules package
meds_list <- as(all_reports, "transactions")
```

1 adverse event report (ae report) == 1 transaction
itemset == set of one or more drugs 

Association measures:

1.  Support. Measures the proportion of ae reports in which an itemset (containing one or more drugs) appears.
2.  Confidence. Measures how likely drug B is taken when drug A is taken,
Confidence (A->B) = Support(A,B)/Support(A).Caveat with confidence: it only accounts for how popular drug A is. If drug B is also very popular in the dataset, there will be a higher chance that an ae report containing drug A will also contain drug B, thus inflating the confidence.
3.  Lift, measures how likely drug B is taken when drug A is taken while accounting for how popular drug B is in the dataset. Lift measures how many times more often drug A and B
are taken together than expected if they were statistically independent. A lift value of 1 indicates independence between drug A and B.



Lets start by defining the minimum support in our dataset. Check the summary of the "transactions"
```{r}
summ_meds_list <- summary((meds_list))
```

We see that the most frequent item(medicine) is `r names(summ_meds_list@itemSummary[1])` and occurs `r summ_meds_list@itemSummary[1]` times in the dataset. It means that this particular medicine has a support of `r summ_meds_list@itemSummary[1]/summ_meds_list@Dim[1]`. For the purposes of this brief exploratory analysis we want to consider medicines that appear at least 5 times in these 10000 reports, therefore we set the minimum support to 5/1000 = `r 5/10000`. We also set minimum confodence at 0.5 and run the apriori algorithm to obtain the association rules for the dataset.

```{r}
#maxlen defines the maximum number or items in a rule and minlen the minimum. minlen is set to 2 to avoid rules of the form {}=>{drug_name}
rules <- apriori(meds_list,parameter = list(supp=0.0005, conf = 0.5, maxlen = 20, minlen = 2))
```

```{r}
rules <- rules[!is.redundant(rules, measure = "lift")]

sorted_rules <- sort(rules, by = "lift", decreasing = T)

inspect(head(sorted_rules, n=50))

```



Visualisations

```{r}
plot(rules, measure=c("support", "lift"), shading="confidence")
```



```{r}
source("http://bioconductor.org/biocLite.R")
    biocLite("Rgraphviz")

rules_to_plot <- head(sorted_rules,15)
plot(rules_to_plot, method = "graph", control = list(type = "items",engine = "graphviz") )


```

